# ============================================================
# üöÄ WhispersCpp-Android ‚Äî CI/CD Smart Release + QR + History Edition v0.7
# ------------------------------------------------------------
# ‚Ä¢ Smart Detect ‚Üí Conditional Build ‚Üí Always Publish
# ‚Ä¢ Auto GitHub Release + QR Code + 20-Release History
# ‚Ä¢ Safe Wiki push / MemorySafe Swap / Glass UI HTML
# ============================================================

name: Android Build & Release (Smart Detect v0.7)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - id: detect
        run: |
          set -Eeuo pipefail
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          DIFF=$(git diff --name-only "$LAST_TAG" HEAD -- app/ nativelib/ **/*.kts **/*.cpp **/*.h **/*.hpp)
          if [ -n "$DIFF" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' }}
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ inputs.branch || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: üß© Add Swap (4GB)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: üß™ Lint & Unit Tests
        if: ${{ inputs.enable_review == true }}
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint issues"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

      - name: üèóÔ∏è Build Release
        run: ./gradlew :app:assembleRelease :app:bundleRelease --stacktrace --no-daemon

      - name: üß† Generate meta/models.json
        id: meta
        run: |
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
          TAG="v${VERSION}-$(date '+%Y%m%d-%H%M')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          jq -n --arg tag "$TAG" --arg date "$DATE" \
            '{version_tag:$tag, generated:$date, source_changed:true, release_history:20}' > meta/models.json
          cat meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: latest-build
          path: |
            app/build/outputs/**/*.apk
            app/build/outputs/**/*.aab
            meta/models.json
          retention-days: 7

  publish:
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - name: üì¶ Retrieve Artifacts or Latest Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifacts meta
          if [ "${{ needs.detect.outputs.changed }}" = "true" ]; then
            gh run download --name latest-build || true
          else
            JSON=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              https://api.github.com/repos/${{ github.repository }}/releases/latest)
            echo "$JSON" | jq -r '.assets[] | select(.name|endswith(".apk")) | .browser_download_url' > urls.txt
            while read -r URL; do
              wget -q --content-disposition "$URL" -P artifacts || true
            done < urls.txt
            jq -n --arg date "$(date '+%Y-%m-%d %H:%M')" \
              '{version_tag:"reuse-latest", generated:$date, source_changed:false, release_history:20}' > meta/models.json
          fi

      - name: üöÄ Auto GitHub Release
        if: ${{ needs.detect.outputs.changed == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag }}
          name: "WhispersCpp Release ${{ needs.build.outputs.tag }}"
          draft: false
          prerelease: false
          files: |
            app/build/outputs/**/*.apk
            app/build/outputs/**/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üåà Generate Wiki + Pages (QR + History)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG=$(jq -r '.version_tag' meta/models.json)
          DATE=$(jq -r '.generated' meta/models.json)
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename ${REPO})/"
          mkdir -p wiki gh-pages

          echo "# üì¶ WhispersCpp-Android (${TAG})" > wiki/Downloads.md
          echo "Updated: ${DATE}" >> wiki/Downloads.md
          echo "" >> wiki/Downloads.md
          echo "## üß© Build Artifacts" >> wiki/Downloads.md
          if compgen -G "artifacts/*.apk" >/dev/null; then
            for f in artifacts/*.apk; do
              N=$(basename "$f")
              echo "- [$N](https://github.com/${REPO}/releases/latest/download/${N})" >> wiki/Downloads.md
            done
          else
            echo "_No APKs found._" >> wiki/Downloads.md
          fi
          echo "" >> wiki/Downloads.md
          echo "## üïì Recent Releases" >> wiki/Downloads.md
          curl -s -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/releases?per_page=20" \
            | jq -r '.[] | "- [" + (.name // .tag_name) + "](" + .html_url + ") (" + (.published_at[0:10]) + ")"' >> wiki/Downloads.md
          echo "" >> wiki/Downloads.md
          echo "<div align=\"center\">" >> wiki/Downloads.md
          echo "<img src=\"https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}\" alt=\"QR\" width=\"180\" height=\"180\"><br>" >> wiki/Downloads.md
          echo "üîó [Open Glass UI Downloads Page](${BASE_URL})" >> wiki/Downloads.md
          echo "</div>" >> wiki/Downloads.md

          # --- Glass UI HTML ---
          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>üì¶ WhispersCpp-Android Downloads</title>
          <style>
            body{font-family:'Inter',system-ui;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,0.4);padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            footer{margin-top:20px;font-size:.9em;opacity:.7}
          </style></head><body><div class="wrap"><div class="glass">
          <h1>üì¶ WhispersCpp-Android</h1>
          <p>Tag: ${TAG} ‚Ä¢ Updated: ${DATE}</p>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR">
          <ul>
          HTML

          if compgen -G "artifacts/*.apk" >/dev/null; then
            for f in artifacts/*.apk; do
              N=$(basename "$f")
              echo "<li><a href='https://github.com/${REPO}/releases/latest/download/${N}'>${N}</a></li>" >> gh-pages/index.html
            done
          else
            echo "<li><em>No APKs found.</em></li>" >> gh-pages/index.html
          fi

          echo "</ul><h3>Recent Releases</h3><ul>" >> gh-pages/index.html
          curl -s -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/releases?per_page=20" \
            | jq -r '.[] | "<li><a href=\"" + .html_url + "\">" + (.name // .tag_name) + "</a> (" + (.published_at[0:10]) + ")</li>"' >> gh-pages/index.html
          echo "</ul><footer>Generated by CI/CD v0.7 ‚Äî Smart Release + QR + History</footer></div></div></body></html>" >> gh-pages/index.html

      - name: üìò Push Wiki (safe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          WIKI_URL="https://${ACTOR}:${GH_TOKEN}@github.com/${REPO}.wiki.git"
          if git ls-remote "$WIKI_URL" &>/dev/null; then
            rm -rf wiki.push && cp -r wiki wiki.push
            cd wiki.push
            git init
            git config user.name "$ACTOR"
            git config user.email "$ACTOR@users.noreply.github.com"
            git add .
            git commit -m "üìò Auto Wiki Update v0.7 Smart Release"
            git branch -M master
            git remote add origin "$WIKI_URL"
            git push origin master --force
          else
            echo "‚ö†Ô∏è Wiki not initialized, skipping push."
          fi

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "üåà Update Pages (v0.7 Smart Release)"
