# ============================================================
# üöÄ AndroidWhispers ‚Äî CI/CD Smart Release + QR + Wiki + Stable APK v1.1.4 (Final Stable)
# ------------------------------------------------------------
# ‚úÖ Auto model info to meta/models.json + Wiki + GH Pages
# ‚úÖ Wiki auto-init and push fixed
# ‚úÖ Always produces valid app-release.apk and working download link
# ‚úÖ Fully jq-safe, robust release & metadata handling
# ============================================================

name: AndroidWhispers ‚Äî Smart Release v1.1.4

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      force_build:
        description: "Force rebuild regardless of diff detection"
        type: boolean
        default: false

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

# ============================================================
# üß† Smart Detect (with Force Build)
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - id: detect
        run: |
          set -Eeuo pipefail
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "‚öôÔ∏è Force Build enabled ‚Äî skipping diff detection."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "üîç Checking for source changes..."
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "üÜï First build"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          DIFF=$(git diff --name-only "$LAST_TAG" HEAD -- app/ nativelib/ **/*.kts **/*.cpp **/*.h **/*.hpp)
          if [ -n "$DIFF" ]; then
            echo "‚úÖ Source changed since $LAST_TAG"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "üü° No source changes since $LAST_TAG"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================
  # üèóÔ∏è Build
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' }}
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ inputs.branch || github.ref_name }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: üß© Add Swap (4GB)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: üß™ Lint & Unit Tests
        if: ${{ inputs.enable_review == true }}
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint warnings"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

      - name: üèóÔ∏è Build Release
        run: |
          ./gradlew clean :app:assembleRelease --stacktrace --no-daemon
          mkdir -p release
          APK_SRC=$(find app/build/outputs -type f -name "*release*.apk" | head -n1)
          if [ -z "$APK_SRC" ]; then
            echo "‚ùå No APK found!"
            exit 1
          fi
          cp "$APK_SRC" release/app-release.apk
          echo "‚úÖ APK prepared: release/app-release.apk"
          ls -lh release/

      # ------------------------------------------------------------
      # üß† Generate meta/models.json with model info
      # ------------------------------------------------------------
      - name: üß† Generate meta/models.json (with model info)
        id: meta
        run: |
          set -e
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "1.0")
          TAG="v${VERSION}-$(date '+%Y%m%d-%H%M')"

          MODEL_DIR="app/src/main/assets/models"
          if [ -d "$MODEL_DIR" ]; then
            echo "üì¶ Collecting models..."
            MODELS_JSON=$(find "$MODEL_DIR" -type f -name "*.bin" -exec bash -c '
              for f; do
                size=$(du -h "$f" | cut -f1)
                name=$(basename "$f")
                echo "{\"name\":\"$name\",\"size\":\"$size\"}"
              done
            ' bash {} + | jq -s '.')
          else
            MODELS_JSON="[]"
          fi

          jq -n \
            --arg tag "$TAG" \
            --arg date "$DATE" \
            --argjson models "$MODELS_JSON" \
            '{version_tag:$tag, generated:$date, models:$models}' > meta/models.json

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          cat meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: |
            release/app-release.apk
            meta/models.json
          retention-days: 7

  # ============================================================
  # üöÄ Publish
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: artifacts

      - name: üöÄ Publish GitHub Release (always latest)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "AndroidWhispers ‚Äî Latest Build"
          draft: false
          prerelease: false
          files: artifacts/release/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìò Ensure Wiki Exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ishizuki-tech/AndroidWhispers"
          WIKI_URL="https://github.com/${REPO}.wiki.git"
          echo "üîé Checking Wiki..."
          if git ls-remote "$WIKI_URL" &>/dev/null; then
            echo "‚úÖ Wiki exists."
          else
            mkdir wiki && cd wiki
            git init
            echo "# üìò AndroidWhispers Wiki" > README.md
            echo "Auto-generated by CI/CD." >> README.md
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add .
            git commit -m "üÜï Initial Wiki setup"
            git branch -M master
            git remote add origin "$WIKI_URL"
            git push origin master --force || true
          fi

      - name: üåà Generate Wiki + Glass UI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          META="artifacts/meta/models.json"
          TAG=$(jq -r '.version_tag' $META || echo "latest")
          DATE=$(jq -r '.generated' $META || date '+%Y-%m-%d %H:%M')
          REPO="ishizuki-tech/AndroidWhispers"
          BASE_URL="https://ishizuki-tech.github.io/AndroidWhispers/"
          mkdir -p wiki gh-pages

          {
            echo "# üì¶ AndroidWhispers (${TAG})"
            echo "Updated: ${DATE}"
            echo ""
            echo "## üß© Latest APK"
            echo "- [app-release.apk](https://github.com/${REPO}/releases/latest/download/app-release.apk)"
            echo ""
            echo "## üéß Whisper Models"
            echo "| Model | Size |"
            echo "|:--|--:|"
            jq -r '.models[]? | "| \(.name) | \(.size) |"' $META || echo "| (none) | |"
            echo ""
            echo "## üïì Recent Releases"
            JSON=$(curl -s -H "Authorization: token ${GH_TOKEN}" "https://api.github.com/repos/${REPO}/releases?per_page=10" || echo "[]")
            echo "$JSON" | jq -er 'if type=="array" then .[] | "- [" + ((.name // .tag_name // "untagged")) + "](" + (.html_url // "#") + ") (" + ((.published_at // "N/A")[0:10]) + ")" else "- (No releases found)" end' || echo "- (No releases found)"
            echo ""
            echo "<div align='center'><img src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}' width='180'></div>"
          } > wiki/Downloads.md

          cd wiki
          git init
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "üìò Auto Wiki Update (${TAG})"
          git branch -M master
          git remote add origin "https://github.com/ishizuki-tech/AndroidWhispers.wiki.git"
          git push origin master --force || echo "‚ö†Ô∏è Wiki push skipped."

      - name: üíé Generate GH Pages (Glass UI)
        run: |
          mkdir -p gh-pages
          TAG=$(jq -r '.version_tag' artifacts/meta/models.json)
          DATE=$(jq -r '.generated' artifacts/meta/models.json)
          BASE_URL="https://ishizuki-tech.github.io/AndroidWhispers/"
          MODELS=$(jq -r '.models[]? | "<li>\(.name) ‚Äî \(.size)</li>"' artifacts/meta/models.json)

          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>üì¶ AndroidWhispers Downloads</title>
          <style>
            body{font-family:'Inter',system-ui;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,0.4);padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            footer{margin-top:20px;font-size:.9em;opacity:.7}
          </style></head><body><div class="wrap"><div class="glass">
          <h1>üì¶ AndroidWhispers</h1>
          <p>Updated: ${DATE}</p>
          <p><a href="https://github.com/ishizuki-tech/AndroidWhispers/releases/latest/download/app-release.apk">‚¨áÔ∏è Download app-release.apk</a></p>
          <h3>üéß Whisper Models</h3>
          <ul>${MODELS}</ul>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR">
          <footer>Generated by AndroidWhispers CI/CD v1.1.4</footer>
          </div></div></body></html>
          HTML

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "üåà Update Pages (AndroidWhispers v1.1.4)"
