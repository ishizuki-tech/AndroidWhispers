# ============================================================
# ğŸš€ AndroidWhispers â€” Smart CI/CD Release + Wiki(master) + Pages + QR v1.1.1-FinalDualStableQR
# ------------------------------------------------------------
# âœ… GH Pages (Glass UI) + Wikiå±¥æ­´ ä¸¡å¯¾å¿œ
# âœ… Wikiã¯å¸¸ã« master
# âœ… Fallback meta + jqå®‰å…¨åŒ–
# âœ… QR + Pagesãƒªãƒ³ã‚¯ã‚’Wiki Home.mdã«è‡ªå‹•è¿½åŠ 
# âœ… Smart Detect + Force Build + Fallback meta
# ============================================================

name: AndroidWhispers â€” Smart Release v1.1.1-FinalDualStableQR

on:
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      force_build:
        description: "Force rebuild regardless of diff detection"
        type: boolean
        default: false

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  OWNER: "ishizuki-tech"
  REPO_NAME: "AndroidWhispers"
  REPO: "ishizuki-tech/AndroidWhispers"
  BASE_URL: "https://ishizuki-tech.github.io/AndroidWhispers"
  WIKI_PAGE_URL: "https://github.com/ishizuki-tech/AndroidWhispers/wiki/Home"
  NDK_VERSION: 28.1.13356709
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

# ============================================================
# ğŸ§  Smart Detect + Conditional Build
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - id: detect
        run: |
          set -Eeuo pipefail
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "âš™ï¸ Force Build enabled â€” skipping diff detection."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ğŸ” Checking for source changes..."
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "ğŸ†• First-time build detected."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED=$(git diff --name-only "$LAST_TAG" HEAD | grep -E '^(app/|nativelib/|.*\.(kt|kts|cpp|hpp|h))' || true)
          if [ -n "$CHANGED" ]; then
            echo "âœ… Source has changed since $LAST_TAG"
            echo "$CHANGED"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸŸ¡ No source changes since $LAST_TAG"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================
  # ğŸ—ï¸ Build + meta/models.json
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' || inputs.force_build == true }}
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ github.ref_name }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: ğŸ§© Add Swap Memory
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo sysctl vm.swappiness=100
          echo "âœ… Swap memory added successfully."
          free -h

      - name: ğŸ“¦ Download Whisper Models (if task exists, with debug)
        run: |
          set -e
          echo "ğŸ” Checking for Gradle task ':app:downloadModel' ..."
          echo "ğŸ§© Gradle version:"
          ./gradlew -v || true
          echo "ğŸ—‚ï¸ Listing available tasks in :app module..."
          ./gradlew -p app tasks --all | tee gradle_tasks.log || true

          if grep -q "downloadModel" gradle_tasks.log; then
            echo "âœ… Found task ':app:downloadModel'. Running..."
            echo "-------------------------------------------"
            ./gradlew :app:downloadModel --stacktrace --no-daemon
            echo "-------------------------------------------"
            echo "ğŸ‰ Model download completed successfully."
          else
            echo "âš ï¸ Task ':app:downloadModel' not found. Skipping model download."
            echo "ğŸ“ Debug info:"
            echo "Current directory: $(pwd)"
            echo "Submodules: $(ls -1)"
            echo "-------------------------------------------"
            echo "If your app/build.gradle.kts defines downloadModel,"
            echo "ensure it's within the ':app' module and Gradle sync succeeds locally."
          fi

      - name: ğŸ§ª Lint & Unit Tests
        if: ${{ inputs.enable_review == true }}
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint warnings"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Unit tests failed"

      - name: ğŸ—ï¸ Build Release APK
        run: |
          ./gradlew clean :app:assembleRelease --stacktrace --no-daemon
          mkdir -p release
          APK=$(find app/build/outputs -type f -name "*release*.apk" | head -n1)
          if [ -z "$APK" ]; then
            echo "âŒ APK not found!"
            exit 1
          fi
          cp "$APK" release/app-release.apk
          echo "âœ… APK ready at release/app-release.apk"

      # ------------------------------------------------------------
      # ğŸ§  Generate meta/models.json with model info
      # ------------------------------------------------------------
      - name: ğŸ§  Generate meta/models.json (with model info)
        id: meta
        run: |
          set -e
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "1.0")
          GIT_HASH=$(git rev-parse --short HEAD)
          TAG="v${VERSION}-${GIT_HASH}-$(date '+%Y%m%d-%H%M')"

          MODEL_DIR="app/src/main/assets/models"
          MODELS_JSON="[]"
          if [ -d "$MODEL_DIR" ]; then
            echo "ğŸ“¦ Collecting model files..."
            MODELS_JSON=$(find "$MODEL_DIR" -type f -name "*.bin" -exec bash -c '
              for f; do
                name=$(basename "$f")
                size_human=$(du -h "$f" | cut -f1)
                size_bytes=$(stat -c%s "$f")
                echo "{\"name\":\"$name\",\"size\":\"$size_human\",\"bytes\":$size_bytes}"
              done
            ' bash {} + | jq -s '.')
          else
            MODELS_JSON="[]"
          fi
          jq -n --arg tag "$TAG" --arg date "$DATE" --argjson models "$MODELS_JSON" \
            '{version_tag:$tag, generated:$date, models:$models}' > meta/models.json

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "âœ… Generated meta/models.json:"
          cat meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: |
            release/app-release.apk
            meta/models.json
          retention-days: 30

      - name: ğŸ“„ CI Summary
        run: |
          TAG=$(jq -r '.version_tag' meta/models.json)
          COUNT=$(jq '.models | length' meta/models.json)
          echo "### âœ… Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- Models: $COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- Build Time: $(date)" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # ğŸš€ Publish (Wiki + Pages dual)
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [build, detect]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¹ Clean Workspace
        run: |
          echo "ğŸ§¹ Removing old wiki/pages/meta..."
          rm -rf wiki gh-pages artifacts/meta || true

      - uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: artifacts
        continue-on-error: true

      - name: ğŸ§© Prepare meta (fallback-safe)
        id: meta
        run: |
          META="artifacts/meta/models.json"
          if [ ! -f "$META" ]; then
            echo "âš ï¸ artifacts/meta/models.json not found, creating fallback."
            mkdir -p meta
            META="meta/models.json"
            jq -n --arg tag "no-build-${RANDOM}" --arg date "$(date '+%Y-%m-%d %H:%M')" \
              '{version_tag:$tag, generated:$date, models:[]}' > "$META"
          fi
          echo "meta_path=$META" >> $GITHUB_OUTPUT

      - name: ğŸŒˆ Generate Wiki (Duplicate-safe + QR)
        run: |
          set -e
          META="${{ steps.meta.outputs.meta_path }}"
          TAG=$(jq -r '.version_tag' "$META")
          DATE=$(jq -r '.generated' "$META")
          mkdir -p wiki/Builds

          echo "# ğŸ“¦ AndroidWhispers â€” Build ${TAG}" > wiki/Builds/${TAG}.md
          echo "Generated: ${DATE}" >> wiki/Builds/${TAG}.md
          echo "" >> wiki/Builds/${TAG}.md
          echo "## ğŸ§© Download" >> wiki/Builds/${TAG}.md
          echo "- [â¬‡ï¸ APK](https://github.com/${REPO}/releases/latest/download/app-release.apk)" >> wiki/Builds/${TAG}.md
          echo "" >> wiki/Builds/${TAG}.md
          echo "## ğŸ§ Whisper Models" >> wiki/Builds/${TAG}.md
          echo "| Model | Size | Bytes |" >> wiki/Builds/${TAG}.md
          echo "|:--|--:|--:|" >> wiki/Builds/${TAG}.md
          jq -r '.models[]? | "| \(.name) | \(.size) | \(.bytes) |"' "$META" >> wiki/Builds/${TAG}.md || true

          echo "ğŸ§© Skipping duplicate copy to root to avoid sidebar duplication."

          echo "# ğŸ  AndroidWhispers Wiki Home" > wiki/Home.md
          echo "Updated: ${DATE}" >> wiki/Home.md
          echo "" >> wiki/Home.md
          echo "## ğŸ“œ Build History (20 latest)" >> wiki/Home.md
          find wiki/Builds -type f -name '*.md' | sort -r | head -n 20 | while read -r f; do
            name=$(basename "$f" .md)
            echo "- [${name}](https://github.com/${REPO}/wiki/Builds/${name})" >> wiki/Home.md
          done
          echo "" >> wiki/Home.md
          echo "## ğŸŒ GH Pages (Glass UI)" >> wiki/Home.md
          echo "- [View Downloads Page](${BASE_URL})" >> wiki/Home.md
          echo "" >> wiki/Home.md
          echo "## ğŸ“± QR Code (for GH Pages)" >> wiki/Home.md
          echo "<p align='center'><img src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}' width='180'></p>" >> wiki/Home.md

          cd wiki
          git init
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .

          git commit -m "ğŸ  Update Wiki ${TAG}" || echo "âš ï¸ No file changes â€” creating empty commit"
          git commit --allow-empty -m "ğŸ“¦ Ensure master branch exists"
          
          git branch -M master
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
          git push origin master --force

      - name: ğŸ’ Generate GH Pages (Glass UI)
        run: |
          set -euo pipefail
          META="${{ steps.meta.outputs.meta_path }}"
          TAG=$(jq -r '.version_tag' "$META")
          DATE=$(jq -r '.generated' "$META")
          mkdir -p gh-pages
          TABLE=$(jq -r '
            [.models[]?] | (["Model","Size","Bytes"] | @tsv),
            (.[] | [.name, .size, (.bytes|tostring)] | @tsv)
          ' "$META" | awk '
            BEGIN {print "<table><tr><th>Model</th><th>Size</th><th>Bytes</th></tr>"}
            NR>1 {printf "<tr><td>%s</td><td>%s</td><td>%s</td></tr>\n",$1,$2,$3}
            END {print "</table>"}
          ')

          echo "âœ… Model table built successfully."

          # ------------------------------------------------------------
          # ğŸ“¦ Copy model binaries if present
          # ------------------------------------------------------------
          cp app/src/main/assets/models/*.bin gh-pages/models/ 2>/dev/null || echo "âš ï¸ No model binaries found locally."

          # ------------------------------------------------------------
          # ğŸ’ Generate Glass UI HTML
          # ------------------------------------------------------------
          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>ğŸ“¦ AndroidWhispers Downloads</title>
          <style>
            body{font-family:'Inter',system-ui;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;
                   box-shadow:0 8px 40px rgba(0,0,0,0.4);
                   padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            table{width:100%;border-collapse:collapse;margin-top:20px}
            th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left}
            th{color:#9df;font-weight:600}
            code{background:#1b2230;padding:2px 6px;border-radius:4px;font-size:.85em;color:#9df;}
            footer{margin-top:24px;font-size:.85em;opacity:.7;text-align:center}
          </style>
          </head>
          <body><div class="wrap"><div class="glass">
          <h1>ğŸ“¦ AndroidWhispers â€” Build ${TAG}</h1>
          <p><strong>Generated:</strong> ${DATE}</p>
          <p><a href="https://github.com/${REPO}/releases/latest/download/app-release.apk">â¬‡ï¸ Download app-release.apk</a></p>
          <p><a href="https://github.com/${REPO}/wiki/${TAG}">ğŸ“˜ View Wiki (${TAG})</a></p>
          <h2>ğŸ§ Whisper Model Catalog</h2>
          ${TABLE}
          <p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR"></p>
          <footer>Generated by AndroidWhispers CI/CD v1.4 â€¢ ${DATE}</footer>
          </div></div></body></html>
          HTML
          ls -lh gh-pages

          echo "âœ… gh-pages/index.html generated"
          ls -lh gh-pages || true

      # ------------------------------------------------------------
      # ğŸš€ Publish GH Pages
      # ------------------------------------------------------------
      - name: ğŸš€ Publish GH Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "ğŸŒˆ Update GH Pages + Wiki (QR Enhanced ${TAG})"
