# ============================================================
# ğŸš€ AndroidWhispers â€” Smart CI/CD Release + Wiki + Pages + QR v1.0.0Final
# ------------------------------------------------------------
# âœ… Auto Wiki Refresh even when no source change
# âœ… Smart Detect (diff-aware) + Force Build mode
# âœ… Full Debug Output + Wiki Auto-Init + GH Pages (Glass UI)
# âœ… Accurate Model Size Info + QR + Summary Log
# ============================================================

name: AndroidWhispers â€” Smart Release v1.0.0Final

on:
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      force_build:
        description: "Force rebuild regardless of diff detection"
        type: boolean
        default: false

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  OWNER: "ishizuki-tech"
  REPO_NAME: "AndroidWhispers"
  REPO: "ishizuki-tech/AndroidWhispers"
  BASE_URL: "https://ishizuki-tech.github.io/AndroidWhispers"
  WIKI_PAGE_URL: "https://github.com/ishizuki-tech/AndroidWhispers/wiki/Home"
  NDK_VERSION: 28.1.13356709
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

# ============================================================
# ğŸ§  Smart Detect
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - id: detect
        run: |
          set -Eeuo pipefail
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "âš™ï¸ Force Build enabled â€” skipping diff detection."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ğŸ” Checking for source changes..."
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "ğŸ†• First-time build detected."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED=$(git diff --name-only "$LAST_TAG" HEAD | grep -E '^(app/|nativelib/|.*\.(kt|kts|cpp|hpp|h))' || true)
          if [ -n "$CHANGED" ]; then
            echo "âœ… Source has changed since $LAST_TAG"
            echo "$CHANGED"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸŸ¡ No source changes since $LAST_TAG"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================
  # ğŸ—ï¸ Build
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' || inputs.force_build == true }}
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ github.ref_name }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: ğŸ§© Add Swap Memory (4GB)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo sysctl vm.swappiness=100
          echo "âœ… Swap memory added successfully."
          free -h

      - name: ğŸ“¦ Download Whisper Models (if task exists, with debug)
        run: |
          set -e
          echo "ğŸ” Checking for Gradle task ':app:downloadModel' ..."
          echo "ğŸ§© Gradle version:"
          ./gradlew -v || true
          echo "ğŸ—‚ï¸ Listing available tasks in :app module..."
          ./gradlew -p app tasks --all | tee gradle_tasks.log || true

          if grep -q "downloadModel" gradle_tasks.log; then
            echo "âœ… Found task ':app:downloadModel'. Running..."
            echo "-------------------------------------------"
            ./gradlew :app:downloadModel --stacktrace --no-daemon
            echo "-------------------------------------------"
            echo "ğŸ‰ Model download completed successfully."
          else
            echo "âš ï¸ Task ':app:downloadModel' not found. Skipping model download."
            echo "ğŸ“ Debug info:"
            echo "Current directory: $(pwd)"
            echo "Submodules: $(ls -1)"
            echo "-------------------------------------------"
            echo "If your app/build.gradle.kts defines downloadModel,"
            echo "ensure it's within the ':app' module and Gradle sync succeeds locally."
          fi

      - name: ğŸ§ª Lint & Unit Tests
        if: ${{ inputs.enable_review == true }}
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint warnings"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Unit tests failed"

      - name: ğŸ—ï¸ Build Release APK
        run: |
          ./gradlew clean :app:assembleRelease --stacktrace --no-daemon
          mkdir -p release
          APK=$(find app/build/outputs -type f -name "*release*.apk" | head -n1)
          if [ -z "$APK" ]; then
            echo "âŒ APK not found!"
            exit 1
          fi
          cp "$APK" release/app-release.apk
          echo "âœ… APK ready at release/app-release.apk"

      # ------------------------------------------------------------
      # ğŸ§  Generate meta/models.json with model info
      # ------------------------------------------------------------
      - name: ğŸ§  Generate meta/models.json (with model info)
        id: meta
        run: |
          set -e
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "1.0")
          GIT_HASH=$(git rev-parse --short HEAD)
          TAG="v${VERSION}-${GIT_HASH}-$(date '+%Y%m%d-%H%M')"

          MODEL_DIR="app/src/main/assets/models"
          if [ -d "$MODEL_DIR" ]; then
            echo "ğŸ“¦ Collecting model files..."
            MODELS_JSON=$(find "$MODEL_DIR" -type f -name "*.bin" -exec bash -c '
              for f; do
                name=$(basename "$f")
                size_human=$(du -h "$f" | cut -f1)
                size_bytes=$(stat -c%s "$f")
                echo "{\"name\":\"$name\",\"size\":\"$size_human\",\"bytes\":$size_bytes}"
              done
            ' bash {} + | jq -s '.')
          else
            MODELS_JSON="[]"
          fi

          jq -n \
            --arg tag "$TAG" \
            --arg date "$DATE" \
            --argjson models "$MODELS_JSON" \
            '{version_tag:$tag, generated:$date, models:$models}' > meta/models.json

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "âœ… Generated meta/models.json:"
          cat meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: |
            release/app-release.apk
            meta/models.json
          retention-days: 30

      - name: ğŸ“„ CI Summary
        run: |
          TAG=$(jq -r '.version_tag' meta/models.json)
          COUNT=$(jq '.models | length' meta/models.json)
          echo "### âœ… Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- Models: $COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- Build Time: $(date)" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # ğŸš€ Publish (always runs for Wiki/Pages refresh)
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [build, detect]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¹ Clean Workspace
        run: |
          echo "ğŸ§¹ Removing old wiki/pages/meta..."
          rm -rf wiki gh-pages artifacts/meta || true

      - uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: artifacts
        continue-on-error: true

      - name: ğŸš€ Publish GitHub Release (latest)
        if: ${{ needs.detect.outputs.changed == 'true' || inputs.force_build == true }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "AndroidWhispers â€” Latest Build"
          draft: false
          prerelease: false
          files: artifacts/release/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“˜ Ensure Wiki Exists (master)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          WIKI_URL="https://github.com/${REPO}.wiki.git"
          echo "ğŸ” Checking Wiki (master branch)..."
          if git ls-remote "$WIKI_URL" &>/dev/null; then
            echo "âœ… Wiki already exists."
          else
            echo "ğŸ†• Creating new Wiki repository (master)..."
            mkdir -p wiki && cd wiki
            git init
            echo "# ğŸ“˜ AndroidWhispers Wiki" > README.md
            echo "Auto-generated by CI/CD." >> README.md
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add .
            git commit -m "ğŸ†• Initial Wiki setup"
            git branch -M master
            git remote add origin "$WIKI_URL"
            git push origin master --force || true
          fi

      - name: ğŸŒˆ Generate Wiki (Home as Index + Build History on master)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "ğŸŒˆ Starting Wiki generation..."
          META="artifacts/meta/models.json"
          TAG=$(jq -r '.version_tag' "$META")
          DATE=$(jq -r '.generated' "$META")
          mkdir -p wiki/Builds gh-pages

          echo "ğŸ“¦ Current TAG: $TAG"
          echo "ğŸ•“ Generated at: $DATE"
          echo "--------------------------------------------"

          # ------------------------------------------------------------
          # ğŸ—‚ï¸ 1. Build-specific page
          # ------------------------------------------------------------
          BUILD_FILE="wiki/Builds/${TAG}.md"
          echo "ğŸ“ Generating build page: ${BUILD_FILE}"
          {
            echo "# ğŸ“¦ AndroidWhispers â€” Build ${TAG}"
            echo "Generated: ${DATE}"
            echo ""
            echo "## ğŸ§© Latest APK"
            echo "- [Download app-release.apk](https://github.com/${REPO}/releases/latest/download/app-release.apk)"
            echo ""
            echo "## ğŸ§ Whisper Models"
            echo "| Model | Size | Bytes |"
            echo "|:--|--:|--:|"
            jq -r '.models[]? | "| \(.name) | \(.size) | \(.bytes) |"' "$META" || echo "| (none) | | |"
            echo ""
            echo "<div align='center'>"
            echo "<img src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}' width='180'>"
            echo "</div>"
          } > "$BUILD_FILE"

          echo "âœ… Build-specific Wiki page created at ${BUILD_FILE}"
          echo "--------------------------------------------"

          # ------------------------------------------------------------
          # ğŸ“„ 1.5 Duplicate Build page to Wiki root
          # ------------------------------------------------------------
          if [ -f "wiki/Builds/${TAG}.md" ]; then
            cp "wiki/Builds/${TAG}.md" "wiki/${TAG}.md"
            echo "âœ… Duplicated ${TAG}.md to Wiki root (for /wiki/${TAG} access)"
          else
            echo "âš ï¸ No build file found to duplicate!"
          fi

          echo "--------------------------------------------"

          # ------------------------------------------------------------
          # ğŸ§­ 2. Generate Wiki Home (Index)
          # ------------------------------------------------------------
          HOME="wiki/Home.md"
          echo "ğŸ§­ Generating Wiki Home (${HOME})"
          {
            echo "# ğŸ  AndroidWhispers Wiki Home"
            echo "Updated: ${DATE}"
            echo ""
            echo "## ğŸ”— Latest Build"
            echo "- [${TAG}](https://github.com/${REPO}/wiki/${TAG})"
            echo ""
            echo "## ğŸ“œ Build History (latest 20)"
            find wiki/Builds -name '*.md' -type f | sort -r | head -n 20 | while read -r f; do
              name=$(basename "$f" .md)
              echo "- [${name}](https://github.com/${REPO}/wiki/${name})"
            done
            echo ""
            echo "## ğŸ“¦ Download Links"
            echo "- [â¬‡ï¸ Latest APK](https://github.com/${REPO}/releases/latest/download/app-release.apk)"
            echo "- [ğŸŒ GitHub Pages](${BASE_URL})"
            echo ""
            echo "<p align='center'>"
            echo "<img src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}' width='180'>"
            echo "</p>"
          } > "$HOME"

          echo "âœ… Wiki Home generated successfully."
          echo "--------------------------------------------"

          # ------------------------------------------------------------
          # ğŸª„ 3. Commit and push (force to master)
          # ------------------------------------------------------------
          cd wiki
          echo "ğŸª„ Preparing to push Wiki..."
          git init
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ğŸ  Update Wiki Home (${TAG})" || echo "â„¹ï¸ No changes to commit."
          git branch -M master
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
          echo "ğŸš€ Pushing Wiki updates to master branch..."
          git push origin master --force || (
            echo "âš ï¸ Wiki push failed â€” retrying..."
            git remote remove origin || true
            git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
            git push origin master --force
          )
          echo "âœ… Wiki push completed successfully."
          echo "--------------------------------------------"

      # ------------------------------------------------------------
      # ğŸ’ Generate GH Pages (Glass UI + meta/models.json support)
      # ------------------------------------------------------------
      - name: ğŸ’ Generate GH Pages (Glass UI + meta/models.json)
        run: |
          set -euo pipefail
          echo "ğŸš€ Generating GH Pages with meta/models.json data..."
          
          META="meta/models.json"
          TAG=$(jq -r '.version_tag' "$META")
          DATE=$(jq -r '.generated' "$META")
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER}.github.io/$(basename $REPO)"
          mkdir -p gh-pages/models

          echo "ğŸ“¦ Repo: $REPO"
          echo "ğŸ·ï¸  Tag: $TAG"
          echo "ğŸ•“  Generated: $DATE"

          # Build detailed table from meta/models.json
          echo "ğŸ§© Building model table..."
          TABLE=$(jq -r '
            [.models[]?] | 
            (["Model","Size","Bytes","Source","Hash"] | @tsv),
            (.[] | [
              (.name // "unknown"),
              (.size // "N/A"),
              (.bytes | tostring),
              (.source // "â€”"),
              (.hash // "â€”")
            ] | @tsv)
          ' "$META" | awk '
            BEGIN { print "<table><tr><th>Model</th><th>Size</th><th>Bytes</th><th>Source</th><th>Hash</th></tr>" }
            NR>1 {
              printf "<tr><td><b>%s</b></td><td>%s</td><td>%s</td><td><a href=\"%s\" target=_blank>link</a></td><td><code>%s</code></td></tr>\\n",$1,$2,$3,$4,$5
            }
            END { print "</table>" }
          ')

          echo "âœ… Model table built successfully."

          # Copy models if present
          cp app/src/main/assets/models/*.bin gh-pages/models/ 2>/dev/null || echo "âš ï¸ No model binaries found locally."

          # Generate Glass UI page
          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>ğŸ“¦ AndroidWhispers Downloads</title>
          <style>
            body{font-family:'Inter',system-ui;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;
                   box-shadow:0 8px 40px rgba(0,0,0,0.4);
                   padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            table{width:100%;border-collapse:collapse;margin-top:20px}
            th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left}
            th{color:#9df;font-weight:600}
            code{background:#1b2230;padding:2px 6px;border-radius:4px;font-size:.85em;color:#9df;}
            footer{margin-top:24px;font-size:.85em;opacity:.7;text-align:center}
          </style>
          </head>
          <body><div class="wrap"><div class="glass">
          <h1>ğŸ“¦ AndroidWhispers â€” Build ${TAG}</h1>
          <p><strong>Generated:</strong> ${DATE}</p>
          <p><a href="https://github.com/${REPO}/releases/latest/download/app-release.apk">â¬‡ï¸ Download app-release.apk</a></p>
          <p><a href="https://github.com/${REPO}/wiki/${TAG}">ğŸ“˜ View Wiki (${TAG})</a></p>
          <h2>ğŸ§ Whisper Model Catalog</h2>
          ${TABLE}
          <p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR"></p>
          <footer>Generated by AndroidWhispers CI/CD v1.4 â€¢ ${DATE}</footer>
          </div></div></body></html>
          HTML

          echo "âœ… gh-pages/index.html generated"
          ls -lh gh-pages || true

      # ------------------------------------------------------------
      # ğŸš€ Publish GH Pages
      # ------------------------------------------------------------
      - name: ğŸš€ Publish GH Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "ğŸŒˆ Update GH Pages (Glass UI + meta/models.json ${TAG})"
