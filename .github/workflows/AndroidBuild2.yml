# ============================================================
# ðŸš€ AndroidWhispers â€” CI/CD Smart Release + QR + History v1.0.0 (Final Stable)
# ------------------------------------------------------------
# â€¢ Project-Specific: AndroidWhispers (ishizuki-tech)
# â€¢ Force Build Option (always rebuild)
# â€¢ Safe jq (no type/index errors)
# â€¢ Auto Wiki Initialization (correct git path)
# â€¢ GH Pages Glass UI + QR + Latest APK link
# ============================================================

name: AndroidWhispers â€” Smart Release v1.0.0

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to build (default: current branch)"
        required: false
        default: ""
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      force_build:
        description: "Force rebuild regardless of diff detection"
        type: boolean
        default: false

permissions:
  contents: write
  pages: write

defaults:
  run:
    shell: bash

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_VERSION: 28.1.13356709
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

# ============================================================
# ðŸ§  Smart Detect (with Force Build option)
# ============================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - id: detect
        run: |
          set -Eeuo pipefail
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "âš™ï¸ Force Build enabled â€” skipping diff detection."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ðŸ” Checking for source changes..."
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "ðŸ†• First build"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          DIFF=$(git diff --name-only "$LAST_TAG" HEAD -- app/ nativelib/ **/*.kts **/*.cpp **/*.h **/*.hpp)
          if [ -n "$DIFF" ]; then
            echo "âœ… Source changed since $LAST_TAG"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "ðŸŸ¡ No source changes since $LAST_TAG"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================
  # ðŸ—ï¸ Build (only if changed or forced)
  # ============================================================
  build:
    runs-on: ubuntu-latest
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' }}
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ inputs.branch || github.ref_name }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: ðŸ§© Add Swap (4GB)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: ðŸ§ª Lint & Unit Tests
        if: ${{ inputs.enable_review == true }}
        run: |
          ./gradlew :app:lintDebug || echo "::warning::Lint warnings"
          ./gradlew :app:testDebugUnitTest || echo "::warning::Tests failed"

      - name: ðŸ—ï¸ Build Release
        run: |
          ./gradlew clean :app:assembleRelease :app:bundleRelease --stacktrace --no-daemon
          echo "ðŸ” Built APKs:"
          find app/build/outputs -type f -name "*.apk" -exec ls -lh {} \;

      - name: ðŸ§  Generate meta/models.json
        id: meta
        run: |
          mkdir -p meta
          DATE=$(date '+%Y-%m-%d %H:%M')
          VERSION=$(grep -E 'versionName' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "1.0")
          TAG="v${VERSION}-$(date '+%Y%m%d-%H%M')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          jq -n --arg tag "$TAG" --arg date "$DATE" \
            '{version_tag:$tag, generated:$date, source_changed:true}' > meta/models.json
          cat meta/models.json

      - uses: actions/upload-artifact@v4
        with:
          name: latest-build
          path: |
            app/build/outputs/**/*.apk
            meta/models.json
          retention-days: 7

  # ============================================================
  # ðŸš€ Publish + Wiki + Pages
  # ============================================================
  publish:
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref_name }}

      - name: ðŸ“¦ Retrieve Artifacts or Latest Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifacts meta
          if [ "${{ needs.detect.outputs.changed }}" = "true" ]; then
            gh run download --name latest-build || true
          else
            echo "â„¹ï¸ No new changes, reusing last release."
            JSON=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              https://api.github.com/repos/${{ github.repository }}/releases/latest)
            echo "$JSON" | jq -r '.assets[] | select(.name|endswith(".apk")) | .browser_download_url' > urls.txt
            while read -r URL; do
              wget -q --content-disposition "$URL" -P artifacts || true
            done < urls.txt
            jq -n --arg date "$(date '+%Y-%m-%d %H:%M')" \
              '{version_tag:"reuse-latest", generated:$date, source_changed:false, release_history:20}' > meta/models.json
          fi

      - name: ðŸš€ Create GitHub Release
        if: ${{ needs.detect.outputs.changed == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag }}
          name: "AndroidWhispers ${{ needs.build.outputs.tag }}"
          files: app/build/outputs/**/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“˜ Ensure Wiki Exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          WIKI_URL="https://${ACTOR}:${GH_TOKEN}@github.com/${REPO}.wiki.git"
          echo "ðŸ”Ž Checking wiki repository..."
          if git ls-remote "$WIKI_URL" &>/dev/null; then
            echo "âœ… Wiki exists."
          else
            echo "ðŸ†• Initializing new Wiki..."
            mkdir -p wiki
            echo "# ðŸ“˜ AndroidWhispers Wiki" > wiki/README.md
            echo "This wiki is auto-generated by CI/CD." >> wiki/README.md
            git init wiki
            cd wiki
            git config user.name "$ACTOR"
            git config user.email "$ACTOR@users.noreply.github.com"
            git add .
            git commit -m "ðŸ†• Initial Wiki setup"
            git branch -M master
            git remote add origin "$WIKI_URL"
            git push origin master --force || true
          fi

      - name: ðŸŒˆ Generate Wiki + Glass UI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG=$(jq -r '.version_tag' meta/models.json)
          DATE=$(jq -r '.generated' meta/models.json)
          REPO="${{ github.repository }}"
          BASE_URL="https://ishizuki-tech.github.io/AndroidWhispers/"
          mkdir -p wiki gh-pages

          echo "# ðŸ“¦ AndroidWhispers (${TAG})" > wiki/Downloads.md
          echo "Updated: ${DATE}" >> wiki/Downloads.md
          echo "" >> wiki/Downloads.md
          echo "## ðŸ§© Latest APKs" >> wiki/Downloads.md
          if compgen -G "artifacts/*.apk" >/dev/null; then
            for f in artifacts/*.apk; do
              N=$(basename "$f")
              echo "- [$N](https://github.com/ishizuki-tech/AndroidWhispers/releases/latest/download/${N})" >> wiki/Downloads.md
            done
          else
            echo "_No APKs found._" >> wiki/Downloads.md
          fi

          echo "" >> wiki/Downloads.md
          echo "## ðŸ•“ Recent Releases" >> wiki/Downloads.md
          curl -s -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/releases?per_page=20" \
            | jq -er 'if type=="array" then .[] | "- [" + ((.name // .tag_name // "untagged")) + "](" + (.html_url // "#") + ") (" + ((.published_at // "N/A")[0:10]) + ")" else "- (No releases found)" end' >> wiki/Downloads.md || echo "- (No releases found)" >> wiki/Downloads.md

          echo "<div align='center'>" >> wiki/Downloads.md
          echo "<img src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}' width='180'>" >> wiki/Downloads.md
          echo "</div>" >> wiki/Downloads.md

          # Push Wiki
          cd wiki
          git init
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ðŸ“˜ Auto Wiki Update (AndroidWhispers v1.0.0)"
          git branch -M master
          git remote add origin "https://github.com/ishizuki-tech/AndroidWhispers.wiki.git"
          git push origin master --force || echo "âš ï¸ Wiki push skipped."

      - name: ðŸ’Ž Generate GH Pages (Glass UI)
        run: |
          mkdir -p gh-pages
          TAG=$(jq -r '.version_tag' meta/models.json)
          DATE=$(jq -r '.generated' meta/models.json)
          BASE_URL="https://ishizuki-tech.github.io/AndroidWhispers/"

          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>ðŸ“¦ AndroidWhispers Downloads</title>
          <style>
            body{font-family:'Inter',system-ui;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,0.4);padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            footer{margin-top:20px;font-size:.9em;opacity:.7}
          </style></head><body><div class="wrap"><div class="glass">
          <h1>ðŸ“¦ AndroidWhispers</h1>
          <p>Tag: ${TAG} â€¢ Updated: ${DATE}</p>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR">
          <ul>
          HTML
          for f in artifacts/*.apk; do
            N=$(basename "$f")
            echo "<li><a href='https://github.com/ishizuki-tech/AndroidWhispers/releases/latest/download/${N}'>${N}</a></li>" >> gh-pages/index.html
          done
          echo "</ul><footer>Generated by AndroidWhispers CI/CD v1.0.0</footer></div></div></body></html>" >> gh-pages/index.html

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "ðŸŒˆ Update Pages (AndroidWhispers v1.0.0)"
